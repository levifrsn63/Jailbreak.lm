<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Jailbreak">
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ”“</text></svg>">
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css" rel="stylesheet" />
    <title>Jailbreak</title>
    <style>
    .code-block{margin:12px 0;position:relative;border-radius:16px;overflow:hidden;background:#2d2d2d;box-shadow:0 4px 12px rgba(0,0,0,0.3)}
    .code-header{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;background:rgba(0,0,0,0.3);border-bottom:1px solid rgba(255,255,255,0.1)}
    .code-lang{font-size:11px;font-weight:600;text-transform:uppercase;color:rgba(255,255,255,0.6);letter-spacing:0.5px}
    .code-actions{display:flex;gap:6px}
    .code-btn{background:rgba(255,255,255,0.1);border:none;padding:6px 12px;border-radius:8px;font-size:11px;color:rgba(255,255,255,0.8);cursor:pointer;transition:all 0.2s;font-weight:500}
    .code-btn:hover{background:rgba(255,255,255,0.2);color:white;transform:translateY(-1px)}
    .code-btn:active{transform:scale(0.95)}
    .code-btn.copied{background:rgba(76,175,80,0.3);color:#4CAF50}
    .code-block pre{margin:0;background:#2d2d2d!important;padding:16px}
    .code-block code{font-family:'SF Mono',Monaco,Consolas,monospace;font-size:14px;line-height:1.6}
    .settings-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);z-index:1000;align-items:center;justify-content:center;overflow-y:auto;backdrop-filter:blur(4px)}
    .settings-modal.show{display:flex}
    .settings-content{background:var(--color-secondary);border-radius:20px;padding:28px;min-width:480px;max-width:600px;max-height:90vh;overflow-y:auto;margin:20px;box-shadow:0 8px 32px rgba(0,0,0,0.5)}
    .settings-content h2{margin:0 0 24px 0;color:var(--color-white);font-size:1.5em}
    .settings-content h3{margin:28px 0 16px 0;color:var(--color-gpt3);font-size:1.1em}
    body{touch-action:pan-x pan-y;overscroll-behavior:none}
    *{touch-action:manipulation}
    .settings-field{margin-bottom:18px}
    .settings-field label{display:block;color:var(--color-groupings);font-size:0.85em;margin-bottom:8px;text-transform:uppercase;letter-spacing:0.5px;font-weight:600}
    .settings-field input,.settings-field textarea{width:100%;background:var(--color-main);border:1px solid var(--color-border1);border-radius:10px;padding:12px;color:var(--color-white);box-sizing:border-box;font-family:inherit;transition:all 0.2s}
    .settings-field input:focus,.settings-field textarea:focus{outline:none;border-color:var(--color-gpt3);box-shadow:0 0 0 3px rgba(95,195,25,0.1)}
    .settings-field textarea{min-height:80px;resize:vertical}
    .settings-actions{display:flex;gap:12px;justify-content:flex-end;margin-top:24px}
    .settings-actions button{border-radius:10px;padding:12px 24px;font-weight:600;transition:all 0.2s}
    .message .content pre{max-width:100%;overflow-x:auto}
    .options-button{position:absolute;right:55px;top:50%;transform:translateY(-50%);background:rgba(255,255,255,0.1);border:1px solid var(--color-border1);border-radius:10px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;color:var(--color-white);cursor:pointer;transition:all 0.2s;z-index:10;padding:0;border:none}
    .options-button:hover{background:rgba(255,255,255,0.15);border-color:var(--color-gpt3);transform:translateY(calc(-50% - 1px))}
    .options-menu{display:none;position:absolute;right:55px;bottom:calc(100% + 8px);background:var(--color-secondary);border:1px solid var(--color-border1);border-radius:12px;padding:12px;min-width:200px;box-shadow:0 8px 32px rgba(0,0,0,0.5);z-index:20;flex-direction:column;gap:12px}
    .options-menu.show{display:flex}
    .options-section{display:flex;flex-direction:column;gap:8px}
    .options-label{color:var(--color-groupings);font-size:0.75em;text-transform:uppercase;letter-spacing:0.5px;font-weight:600;margin-bottom:4px}
    .options-select{background:var(--color-main);border:1px solid var(--color-border1);border-radius:8px;padding:8px 12px;color:var(--color-white);font-size:0.9em;cursor:pointer;transition:all 0.2s;width:100%}
    .options-select:focus{outline:none;border-color:var(--color-gpt3);box-shadow:0 0 0 3px rgba(99,102,241,0.1)}
    .options-toggle{display:flex;align-items:center;gap:10px;color:var(--color-white);font-size:0.9em;cursor:pointer}
    .options-toggle input[type="checkbox"]{width:18px;height:18px;cursor:pointer;accent-color:var(--color-gpt3)}
    .options-toggle span{user-select:none}
    .send-button{width:38px;height:38px;padding:0!important;display:flex;align-items:center;justify-content:center;border-radius:10px!important}
    .jailbreak-preset{background:var(--color-main);border:1px solid var(--color-border1);border-radius:12px;padding:16px;margin-bottom:16px}
    .jailbreak-preset h4{margin:0 0 10px 0;color:var(--color-white);font-size:0.95em}
    .jailbreak-preset p{margin:0 0 8px 0;color:var(--color-groupings);font-size:0.8em;line-height:1.5}
    .jailbreak-preset p:last-child{margin-bottom:0}
    #messagesList{scroll-behavior:smooth;position:relative}
    .scroll-to-bottom-btn{position:fixed;bottom:120px;left:50%;margin-left:450px;width:32px;height:32px;border-radius:50%;background:var(--color-gpt3);border:none;color:white;cursor:pointer;display:none;align-items:center;justify-content:center;box-shadow:0 4px 12px rgba(0,0,0,0.3);transition:all 0.2s cubic-bezier(0.4,0,0.2,1);z-index:100;opacity:0;pointer-events:none}
    .scroll-to-bottom-btn.show{display:flex;opacity:1;pointer-events:auto}
    .scroll-to-bottom-btn:hover{background:var(--color-gpt4);transform:scale(1.1);box-shadow:0 6px 16px rgba(0,0,0,0.4)}
    .scroll-to-bottom-btn:active{transform:scale(0.95)}
    .scroll-to-bottom-btn i{font-size:14px}
    .markdown-content{line-height:1.6}
    .markdown-content strong{font-weight:700;color:var(--color-white)}
    .markdown-content em{font-style:italic;opacity:0.9}
    .markdown-content code{background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;font-family:'SF Mono',Monaco,Consolas,monospace;font-size:0.9em}
    .markdown-content a{color:var(--color-gpt3);text-decoration:underline;transition:opacity 0.2s}
    .markdown-content a:hover{opacity:0.8}
    .markdown-content h1,.markdown-content h2,.markdown-content h3{margin:16px 0 8px 0;font-weight:600;color:var(--color-white)}
    .markdown-content ul,.markdown-content ol{margin:8px 0;padding-left:24px}
    .markdown-content li{margin:4px 0}
    .markdown-content p{margin:8px 0}
    .startup-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:var(--color-main);z-index:2000;align-items:center;justify-content:center;overflow-y:auto}
    .startup-modal.show{display:flex}
    .startup-content{background:transparent;border-radius:0;padding:48px 40px;min-width:400px;max-width:500px;text-align:center;animation:fadeIn 0.4s cubic-bezier(0.4,0,0.2,1);width:100%;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center}
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    .startup-content h1{margin:0 0 32px 0;color:var(--color-white);font-size:2.5em;font-weight:700;letter-spacing:-0.5px}
    .startup-buttons{display:flex;flex-direction:column;gap:16px;margin:32px 0}
    .startup-btn{background:linear-gradient(135deg,var(--color-gpt3),var(--color-gpt4));border:none;border-radius:12px;padding:16px 32px;color:white;font-size:1.1em;font-weight:600;cursor:pointer;transition:all 0.3s cubic-bezier(0.4,0,0.2,1);box-shadow:0 4px 12px rgba(95,195,25,0.3)}
    .startup-btn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(95,195,25,0.4)}
    .startup-btn:active{transform:translateY(0)}
    .startup-btn.secondary{background:rgba(255,255,255,0.1);box-shadow:0 4px 12px rgba(0,0,0,0.2)}
    .startup-btn.secondary:hover{background:rgba(255,255,255,0.15);box-shadow:0 6px 20px rgba(0,0,0,0.3)}
    .startup-footer{position:absolute;bottom:40px;left:50%;transform:translateX(-50%);margin-top:40px;padding-top:24px;border-top:1px solid rgba(255,255,255,0.1);color:var(--color-groupings);font-size:0.9em;width:100%;max-width:500px}
    @media (max-width: 768px){.startup-content{min-width:auto;width:100%;padding:36px 28px}.startup-content h1{font-size:2em}.startup-buttons{gap:12px}.startup-btn{padding:14px 24px;font-size:1em}.startup-footer{bottom:20px;padding-top:16px}}
    </style>
</head>
<body>
    <div class="startup-modal" id="startupModal">
        <div class="startup-content">
            <h1>Jailbreak.LM -ng</h1>
            <div class="startup-buttons">
                <button class="startup-btn" id="getStartedBtn">Get Started</button>
                <button class="startup-btn secondary" id="githubBtn">Github</button>
            </div>
            <div class="startup-footer">created by levifrsn63</div>
        </div>
    </div>
    <nav id="sidebar">
        <div class="float-top">
            <div class="sidebar-controls">
                <button class="new-chat" id="newChatBtn"><i class="fa fa-plus"></i> New chat</button>
            </div>
            <ul class="conversations" id="conversationsList"></ul>
        </div>
        <div class="user-menu">
            <button id="userMenuBtn">
                <i class="user-icon">u</i>
                Settings
                <i class="fa fa-ellipsis dots"></i>
            </button>
            <ul id="userMenuDropdown">
                <li><button id="settingsBtn">API Keys & Settings</button></li>
                <li><button id="themeToggleBtn">Toggle Dark Mode</button></li>
            </ul>
        </div>
    </nav>
    <button class="hide-sidebar" id="toggleSidebar"><i class="fa fa-chevron-left"></i></button>
    <main>
        <div class="view new-chat-view" id="newChatView">
            <div class="model-selector">
                <button class="gpt-3 selected" data-provider="openai">
                    <i class="fa fa-bolt"></i> OpenAI
                </button>
                <button class="gpt-4" data-provider="anthropic">
                    <i class="fa fa-wand-magic-sparkles"></i> Anthropic
                </button>
                <button class="gpt-3" data-provider="deepseek">
                    <i class="fa fa-rocket"></i> DeepSeek
                </button>
            </div>

            <div class="logo">Jailbreak.LM -ng</div>
        </div>

        <div class="view conversation-view" id="conversationView">
            <button id="mobileMenuBtn" class="mobile-menu-btn" title="Menu">
                <i class="fa fa-bars"></i>
            </button>
            <div id="messagesList"></div>
            <button id="scrollToBottomBtn" class="scroll-to-bottom-btn" title="Scroll to bottom">
                <i class="fa fa-chevron-down"></i>
            </button>
            <div id="sidebarOverlay" class="sidebar-overlay"></div>
        </div>

        <div id="message-form">
            <div class="message-wrapper">
                <textarea id="message" rows="1" placeholder="Send a message"></textarea>
                <button class="options-button" id="optionsBtn" title="Options"><i class="fa fa-ellipsis"></i></button>
                <div class="options-menu" id="optionsMenu">
                    <div class="options-section">
                        <label class="options-label">Model</label>
                        <select id="modelSelect" class="options-select">
                            <option value="">Default</option>
                            <optgroup label="OpenAI">
                                <option value="gpt-4o">GPT-4o</option>
                                <option value="gpt-4o-mini">GPT-4o Mini</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5</option>
                            </optgroup>
                            <optgroup label="Anthropic">
                                <option value="claude-3-5-sonnet-20241022">Claude 3.5 Sonnet</option>
                                <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                                <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                            </optgroup>
                            <optgroup label="DeepSeek">
                                <option value="deepseek-chat">DeepSeek Chat</option>
                                <option value="deepseek-coder">DeepSeek Coder</option>
                            </optgroup>
                        </select>
                    </div>
                    <div class="options-section">
                        <label class="options-toggle">
                            <input type="checkbox" id="optionsWebSearch" />
                            <span>Web Search</span>
                        </label>
                    </div>
                    <div class="options-section">
                        <label class="options-toggle">
                            <input type="checkbox" id="optionsDisposableChat" />
                            <span>Disposable Chat Mode</span>
                        </label>
                    </div>
                </div>
                <button class="send-button" id="sendBtn"><i class="fa fa-paper-plane"></i></button>
            </div>
            <div class="disclaimer">Jailbreak.LM -ng - Unrestricted AI conversations with OpenAI, Anthropic, and DeepSeek</div>
        </div>
    </main>

    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <h2>API Keys & Settings</h2>
            
            <h3>API Keys</h3>
            <div class="settings-field">
                <label>OpenAI API Key</label>
                <input type="password" id="openaiKey" placeholder="sk-..." />
            </div>
            <div class="settings-field">
                <label>Anthropic API Key</label>
                <input type="password" id="anthropicKey" placeholder="sk-ant-..." />
            </div>
            <div class="settings-field">
                <label>DeepSeek API Key</label>
                <input type="password" id="deepseekKey" placeholder="sk-..." />
            </div>
            <div class="settings-field">
                <label>Custom Endpoint</label>
                <input type="text" id="customEndpoint" placeholder="https://api.example.com/v1/chat" />
            </div>
            <div class="settings-field">
                <label>Custom API Key</label>
                <input type="password" id="customKey" placeholder="Your API key" />
            </div>
            
            <h3>Model Parameters</h3>
            <div class="settings-field">
                <label>Temperature (0-2)</label>
                <input type="number" id="tempInput" min="0" max="2" step="0.1" value="0.7" />
            </div>
            <div class="settings-field">
                <label>Max Tokens</label>
                <input type="number" id="maxTokensInput" min="16" max="4096" value="1024" />
            </div>
            
            <h3>Chat Settings</h3>
            <div class="settings-field">
                <label style="display:flex;align-items:center;gap:8px">
                    <input type="checkbox" id="disposableChat" style="width:auto;margin:0" />
                    <span>Disposable Chat Mode (Single-use, clears after each response)</span>
                </label>
            </div>
            
            <h3>Web Search</h3>
            <div class="settings-field">
                <label style="display:flex;align-items:center;gap:8px">
                    <input type="checkbox" id="enableWebSearch" style="width:auto;margin:0" />
                    <span>Enable Web Search</span>
                </label>
            </div>
            <div class="settings-field">
                <label>Web Search API Key (Optional - for custom search API)</label>
                <input type="password" id="webSearchKey" placeholder="Leave empty to use default search" />
            </div>
            <div class="settings-field">
                <label>Search Provider</label>
                <select id="searchProvider" style="width:100%;background:var(--color-main);border:1px solid var(--color-border1);border-radius:10px;padding:12px;color:var(--color-white);box-sizing:border-box;font-family:inherit">
                    <option value="duckduckgo">DuckDuckGo (No API key needed)</option>
                    <option value="google">Google Custom Search (API key required)</option>
                    <option value="serpapi">SerpAPI (API key required)</option>
                </select>
            </div>
            
            <h3>Jailbreaks (System Prompts)</h3>
            <p style="color:var(--color-groupings);font-size:0.85em;margin-bottom:16px">Pre-prompts that optimize each model's performance. Customize these for your needs.</p>
            
            <div class="settings-field">
                <label>OpenAI System Prompt</label>
                <textarea id="openaiJailbreak" placeholder="System prompt for OpenAI models..."></textarea>
            </div>
            
            <div class="settings-field">
                <label>Anthropic System Prompt</label>
                <textarea id="anthropicJailbreak" placeholder="System prompt for Anthropic models..."></textarea>
            </div>
            
            <div class="settings-field">
                <label>DeepSeek System Prompt</label>
                <textarea id="deepseekJailbreak" placeholder="System prompt for DeepSeek models..."></textarea>
            </div>
            
            <div class="jailbreak-preset">
                <h4>ðŸ’¡ Preset Suggestions</h4>
                <p><strong>OpenAI:</strong> "You are a helpful, creative, and intelligent AI assistant. Provide detailed, accurate answers."</p>
                <p><strong>Anthropic:</strong> "You are Claude, an AI assistant created by Anthropic. You are helpful, harmless, and honest."</p>
                <p><strong>DeepSeek:</strong> "You are a helpful assistant with expertise in coding and technical topics. Provide clear, concise answers."</p>
            </div>
            
            <div class="settings-actions">
                <button id="closeSettings">Cancel</button>
                <button id="saveSettings" style="background:var(--color-gpt3)">Save</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-c.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-cpp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-go.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-rust.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-typescript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-csharp.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-jsx.min.js"></script>
    <script>
    // Default jailbreaks
    const DEFAULT_JAILBREAKS = {
        openai: "You are a helpful, creative, and intelligent AI assistant. Provide detailed, accurate, and well-structured answers. When writing code, use proper formatting and include comments where helpful.",
        anthropic: "You are Claude, an AI assistant created by Anthropic. You are helpful, harmless, and honest. You provide thoughtful, nuanced responses and acknowledge uncertainty when appropriate.",
        deepseek: "You are a helpful assistant with deep expertise in coding and technical topics. Provide clear, concise, and accurate answers with code examples when relevant. Focus on best practices and efficient solutions."
    };

    const state = {
        provider: localStorage.getItem('provider') || 'openai',
        currentChatId: null,
        chats: JSON.parse(localStorage.getItem('chats') || '[]'),
        sidebarHidden: localStorage.getItem('sidebar_hidden') !== null ? localStorage.getItem('sidebar_hidden') === 'true' : true, // Default to collapsed
        disposableChat: localStorage.getItem('disposable_chat') === 'true',
        enableWebSearch: localStorage.getItem('enable_web_search') === 'true',
        jailbreaks: {
            openai: localStorage.getItem('jailbreak_openai') || DEFAULT_JAILBREAKS.openai,
            anthropic: localStorage.getItem('jailbreak_anthropic') || DEFAULT_JAILBREAKS.anthropic,
            deepseek: localStorage.getItem('jailbreak_deepseek') || DEFAULT_JAILBREAKS.deepseek
        }
    };

    // UI Elements
    const sidebar = document.getElementById('sidebar');
    const newChatView = document.getElementById('newChatView');
    const conversationView = document.getElementById('conversationView');
    const messagesList = document.getElementById('messagesList');
    const messageInput = document.getElementById('message');
    const settingsModal = document.getElementById('settingsModal');
    const startupModal = document.getElementById('startupModal');
    const userMenuDropdown = document.getElementById('userMenuDropdown');

    // Sidebar toggle function
    const sidebarOverlay = document.getElementById('sidebarOverlay');
    function toggleSidebar() {
        state.sidebarHidden = !state.sidebarHidden;
        localStorage.setItem('sidebar_hidden', state.sidebarHidden);
        sidebar.classList.toggle('hidden');
        document.body.classList.toggle('sidebar-hidden', state.sidebarHidden);
        if (sidebarOverlay) {
            sidebarOverlay.classList.toggle('show', !state.sidebarHidden);
        }
    }
    
    // Desktop sidebar toggle
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    if (toggleSidebarBtn) {
        toggleSidebarBtn.addEventListener('click', toggleSidebar);
    }
    
    // Mobile menu button
    const mobileMenuBtn = document.getElementById('mobileMenuBtn');
    if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', toggleSidebar);
    }
    
    // Close sidebar when clicking overlay on mobile
    if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', () => {
            if (!state.sidebarHidden) {
                state.sidebarHidden = true;
                sidebar.classList.add('hidden');
                sidebarOverlay.classList.remove('show');
            }
        });
    }

    // User menu
    document.getElementById('userMenuBtn').addEventListener('click', () => {
        userMenuDropdown.classList.toggle('show-animate');
        setTimeout(() => userMenuDropdown.classList.toggle('show'), 10);
    });

    // Settings modal
    document.getElementById('settingsBtn').addEventListener('click', () => {
        document.getElementById('openaiKey').value = localStorage.getItem('openai_key') || '';
        document.getElementById('anthropicKey').value = localStorage.getItem('anthropic_key') || '';
        document.getElementById('deepseekKey').value = localStorage.getItem('deepseek_key') || '';
        document.getElementById('customEndpoint').value = localStorage.getItem('custom_endpoint') || '';
        document.getElementById('customKey').value = localStorage.getItem('custom_key') || '';
        document.getElementById('tempInput').value = localStorage.getItem('temperature') || '0.7';
        document.getElementById('maxTokensInput').value = localStorage.getItem('max_tokens') || '1024';
        document.getElementById('disposableChat').checked = state.disposableChat;
        document.getElementById('enableWebSearch').checked = state.enableWebSearch;
        document.getElementById('webSearchKey').value = localStorage.getItem('web_search_key') || '';
        document.getElementById('searchProvider').value = localStorage.getItem('search_provider') || 'duckduckgo';
        
        // Load jailbreaks
        document.getElementById('openaiJailbreak').value = state.jailbreaks.openai;
        document.getElementById('anthropicJailbreak').value = state.jailbreaks.anthropic;
        document.getElementById('deepseekJailbreak').value = state.jailbreaks.deepseek;
        
        settingsModal.classList.add('show');
    });

    document.getElementById('closeSettings').addEventListener('click', () => {
        settingsModal.classList.remove('show');
    });

    document.getElementById('saveSettings').addEventListener('click', () => {
        localStorage.setItem('openai_key', document.getElementById('openaiKey').value.trim());
        localStorage.setItem('anthropic_key', document.getElementById('anthropicKey').value.trim());
        localStorage.setItem('deepseek_key', document.getElementById('deepseekKey').value.trim());
        localStorage.setItem('custom_endpoint', document.getElementById('customEndpoint').value.trim());
        localStorage.setItem('custom_key', document.getElementById('customKey').value.trim());
        localStorage.setItem('temperature', document.getElementById('tempInput').value);
        localStorage.setItem('max_tokens', document.getElementById('maxTokensInput').value);
        
        // Save chat settings
        state.disposableChat = document.getElementById('disposableChat').checked;
        state.enableWebSearch = document.getElementById('enableWebSearch').checked;
        localStorage.setItem('disposable_chat', state.disposableChat);
        localStorage.setItem('enable_web_search', state.enableWebSearch);
        
        localStorage.setItem('web_search_key', document.getElementById('webSearchKey').value.trim());
        localStorage.setItem('search_provider', document.getElementById('searchProvider').value);
        
        // Update options menu checkboxes
        if (typeof window.updateOptionsMenu === 'function') {
            window.updateOptionsMenu();
        }
        
        // Save jailbreaks
        state.jailbreaks.openai = document.getElementById('openaiJailbreak').value.trim();
        state.jailbreaks.anthropic = document.getElementById('anthropicJailbreak').value.trim();
        state.jailbreaks.deepseek = document.getElementById('deepseekJailbreak').value.trim();
        localStorage.setItem('jailbreak_openai', state.jailbreaks.openai);
        localStorage.setItem('jailbreak_anthropic', state.jailbreaks.anthropic);
        localStorage.setItem('jailbreak_deepseek', state.jailbreaks.deepseek);
        
        settingsModal.classList.remove('show');
    });

    // Theme toggle functionality
    const themeToggleBtn = document.getElementById('themeToggleBtn');
    
    window.applyTheme = function(theme) {
        if (theme === 'light') {
            document.body.classList.add('light-mode');
            if (themeToggleBtn) {
                themeToggleBtn.textContent = 'Toggle Light Mode';
            }
        } else {
            document.body.classList.remove('light-mode');
            if (themeToggleBtn) {
                themeToggleBtn.textContent = 'Toggle Dark Mode';
            }
        }
        localStorage.setItem('theme', theme);
    };
    
    if (themeToggleBtn) {
        themeToggleBtn.addEventListener('click', () => {
            const isLight = document.body.classList.contains('light-mode');
            window.applyTheme(isLight ? 'dark' : 'light');
        });
    }

    // Options menu functionality
    const optionsBtn = document.getElementById('optionsBtn');
    const optionsMenu = document.getElementById('optionsMenu');
    const optionsWebSearch = document.getElementById('optionsWebSearch');
    const optionsDisposableChat = document.getElementById('optionsDisposableChat');
    const modelSelect = document.getElementById('modelSelect');
    
    // Function to update options menu from state
    window.updateOptionsMenu = function() {
        if (optionsWebSearch) {
            optionsWebSearch.checked = state.enableWebSearch;
        }
        if (optionsDisposableChat) {
            optionsDisposableChat.checked = state.disposableChat;
        }
    };
    
    // Initialize options menu state
    updateOptionsMenu();
    
    // Toggle options menu
    if (optionsBtn && optionsMenu) {
        optionsBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            optionsMenu.classList.toggle('show');
        });
        
        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
            if (optionsMenu && !optionsMenu.contains(e.target) && !optionsBtn.contains(e.target)) {
                optionsMenu.classList.remove('show');
            }
        });
    }
    
    // Handle web search toggle
    if (optionsWebSearch) {
        optionsWebSearch.addEventListener('change', (e) => {
            state.enableWebSearch = e.target.checked;
            localStorage.setItem('enable_web_search', state.enableWebSearch);
            // Update settings modal if open
            const settingsWebSearch = document.getElementById('enableWebSearch');
            if (settingsWebSearch) {
                settingsWebSearch.checked = state.enableWebSearch;
            }
        });
    }
    
    // Handle disposable chat toggle
    if (optionsDisposableChat) {
        optionsDisposableChat.addEventListener('change', (e) => {
            state.disposableChat = e.target.checked;
            localStorage.setItem('disposable_chat', state.disposableChat);
            // Update settings modal if open
            const settingsDisposableChat = document.getElementById('disposableChat');
            if (settingsDisposableChat) {
                settingsDisposableChat.checked = state.disposableChat;
            }
        });
    }
    
    // Handle model selection
    if (modelSelect) {
        modelSelect.addEventListener('change', (e) => {
            // Model is stored per message, no need to update state
        });
    }

    // Provider selection
    document.querySelectorAll('.model-selector button').forEach(btn => {
        btn.addEventListener('click', () => {
            document.querySelectorAll('.model-selector button').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            state.provider = btn.dataset.provider;
            localStorage.setItem('provider', state.provider);
        });
    });

    // Chat management
    function saveChats() {
        localStorage.setItem('chats', JSON.stringify(state.chats));
    }

    function createNewChat() {
        const chat = {
            id: Date.now().toString(),
            title: 'New Chat',
            messages: [],
            created: Date.now()
        };
        state.chats.unshift(chat);
        saveChats();
        loadChat(chat.id);
        renderChatList();
    }

    function loadChat(chatId) {
        const chat = state.chats.find(c => c.id === chatId);
        if (!chat) return;
        
        state.currentChatId = chatId;
        messagesList.innerHTML = '';
        newChatView.style.display = 'none';
        conversationView.style.display = 'flex';
        
        chat.messages.forEach(msg => {
            appendMessage(msg.role, msg.content, false);
        });
        
        // Scroll to bottom after loading all messages
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                scrollToBottom(false);
                setTimeout(() => {
                    checkScrollPosition();
                }, 100);
            });
        });
        
        renderChatList();
    }

    function deleteChat(chatId, event) {
        event.stopPropagation();
        state.chats = state.chats.filter(c => c.id !== chatId);
        saveChats();
        if (state.currentChatId === chatId) {
            state.currentChatId = null;
            messagesList.innerHTML = '';
            newChatView.style.display = 'flex';
            conversationView.style.display = 'none';
        }
        renderChatList();
    }

    function renderChatList() {
        const container = document.getElementById('conversationsList');
        container.innerHTML = '';
        
        const grouped = { today: [], yesterday: [], week: [], older: [] };
        const now = Date.now();
        const day = 24 * 60 * 60 * 1000;
        
        state.chats.forEach(chat => {
            const age = now - chat.created;
            if (age < day) grouped.today.push(chat);
            else if (age < 2 * day) grouped.yesterday.push(chat);
            else if (age < 7 * day) grouped.week.push(chat);
            else grouped.older.push(chat);
        });
        
        const sections = [
            { label: 'Today', chats: grouped.today },
            { label: 'Yesterday', chats: grouped.yesterday },
            { label: 'Previous 7 days', chats: grouped.week },
            { label: 'Older', chats: grouped.older }
        ];
        
        sections.forEach(section => {
            if (section.chats.length === 0) return;
            
            const grouping = document.createElement('li');
            grouping.className = 'grouping';
            grouping.textContent = section.label;
            container.appendChild(grouping);
            
            section.chats.forEach(chat => {
                const li = document.createElement('li');
                if (chat.id === state.currentChatId) li.classList.add('active');
                
                const btn = document.createElement('button');
                btn.className = 'conversation-button';
                btn.innerHTML = `<i class="fa fa-message fa-regular"></i> ${chat.title}`;
                btn.onclick = () => {
                    loadChat(chat.id);
                    // Close sidebar on mobile after selecting chat
                    if (window.innerWidth <= 768 && !state.sidebarHidden) {
                        state.sidebarHidden = true;
                        sidebar.classList.add('hidden');
                        if (sidebarOverlay) {
                            sidebarOverlay.classList.remove('show');
                        }
                    }
                };
                
                const fade = document.createElement('div');
                fade.className = 'fade';
                
                const editButtons = document.createElement('div');
                editButtons.className = 'edit-buttons';
                editButtons.innerHTML = `
                    <button><i class="fa fa-edit"></i></button>
                    <button onclick="deleteChat('${chat.id}', event)"><i class="fa fa-trash"></i></button>
                `;
                
                li.appendChild(btn);
                li.appendChild(fade);
                li.appendChild(editButtons);
                container.appendChild(li);
            });
        });
    }

    window.deleteChat = deleteChat;

    document.getElementById('newChatBtn').addEventListener('click', () => {
        createNewChat();
        // Close sidebar on mobile after creating new chat
        if (window.innerWidth <= 768 && !state.sidebarHidden) {
            state.sidebarHidden = true;
            sidebar.classList.add('hidden');
            if (sidebarOverlay) {
                sidebarOverlay.classList.remove('show');
            }
        }
    });

    // Code block functions
    function copyCode(code, btn) {
        navigator.clipboard.writeText(code).then(() => {
            const orig = btn.textContent;
            btn.textContent = 'Copied!';
            btn.classList.add('copied');
            setTimeout(() => {
                btn.textContent = orig;
                btn.classList.remove('copied');
            }, 2000);
        });
    }

    function downloadCode(code, language) {
        const extensions = {
            javascript: 'js', js:'js', python: 'py', java: 'java', c: 'c', cpp: 'cpp',
            'c++':'cpp', csharp:'cs', 'c#':'cs', go: 'go', rust: 'rs', typescript: 'ts',
            ts:'ts', jsx:'jsx', tsx:'tsx', bash: 'sh', shell:'sh', json: 'json', 
            sql: 'sql', html:'html', css:'css', yaml:'yaml', yml:'yml', 
            markdown:'md', md:'md', php:'php', ruby:'rb', swift:'swift', 
            kotlin:'kt', scala:'scala', perl:'pl', r:'r'
        };
        const ext = extensions[language.toLowerCase()] || 'txt';
        const blob = new Blob([code], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `code.${ext}`;
        a.click();
        URL.revokeObjectURL(url);
    }

    function createCodeBlock(language, code) {
        const codeBlock = document.createElement('div');
        codeBlock.className = 'code-block';

        const header = document.createElement('div');
        header.className = 'code-header';

        const langLabel = document.createElement('div');
        langLabel.className = 'code-lang';
        langLabel.textContent = language || 'text';

        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'code-actions';

        const copyBtn = document.createElement('button');
        copyBtn.className = 'code-btn';
        copyBtn.textContent = 'Copy';
        copyBtn.onclick = function () { copyCode(code, this); };

        const downloadBtn = document.createElement('button');
        downloadBtn.className = 'code-btn';
        downloadBtn.textContent = 'Download';
        downloadBtn.onclick = () => downloadCode(code, language);

        actionsDiv.appendChild(copyBtn);
        actionsDiv.appendChild(downloadBtn);

        header.appendChild(langLabel);
        header.appendChild(actionsDiv);

        const pre = document.createElement('pre');
        const codeEl = document.createElement('code');
        codeEl.className = `language-${language || 'text'}`;
        codeEl.textContent = code;
        pre.appendChild(codeEl);

        codeBlock.appendChild(header);
        codeBlock.appendChild(pre);

        Prism.highlightElement(codeEl);

        return codeBlock;
    }

    function parseMessageContent(content) {
        const parts = [];
        let currentIndex = 0;
        
        // More comprehensive regex that handles edge cases
        // Matches: ```language\ncode``` or ```\ncode```
        const codeBlockRegex = /```([a-zA-Z0-9_+-]*)\n([\s\S]*?)```/g;
        
        let match;
        while ((match = codeBlockRegex.exec(content)) !== null) {
            // Add text before code block if any
            if (match.index > currentIndex) {
                const textContent = content.substring(currentIndex, match.index).trim();
                if (textContent) {
                    parts.push({ type: 'text', content: textContent });
                }
            }
            
            // Add code block
            const language = match[1].trim() || 'text';
            const code = match[2];
            
            // Only add if code is not empty
            if (code.trim()) {
                parts.push({ 
                    type: 'code', 
                    language: language, 
                    content: code.trim() 
                });
            }
            
            currentIndex = match.index + match[0].length;
        }
        
        // Add remaining text after last code block
        if (currentIndex < content.length) {
            const textContent = content.substring(currentIndex).trim();
            if (textContent) {
                parts.push({ type: 'text', content: textContent });
            }
        }
        
        // If no parts were found, return the entire content as text
        return parts.length > 0 ? parts : [{ type: 'text', content: content }];
    }

    // Simple markdown parser for text content
    function parseMarkdown(text) {
        if (!text) return '';
        
        let html = text;
        
        // Escape HTML to prevent XSS
        html = html.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
        
        // Code blocks (already handled separately, but handle inline code)
        html = html.replace(/`([^`]+)`/g, '<code style="background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;font-family:monospace;font-size:0.9em">$1</code>');
        
        // Bold: **text** or __text__ (do this first to avoid conflicts with italic)
        html = html.replace(/\*\*([^*]+?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/__([^_]+?)__/g, '<strong>$1</strong>');
        
        // Italic: *text* or _text_ (process after bold to avoid conflicts)
        // Use a simple regex that matches single asterisks/underscores not part of bold
        html = html.replace(/(^|[^*])\*([^*\n]+?)\*([^*]|$)/g, '$1<em>$2</em>$3');
        html = html.replace(/(^|[^_])_([^_\n]+?)_([^_]|$)/g, '$1<em>$2</em>$3');
        
        // Links: [text](url)
        html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer" style="color:var(--color-gpt3);text-decoration:underline">$1</a>');
        
        // Headers
        html = html.replace(/^### (.*$)/gm, '<h3 style="font-size:1.1em;font-weight:600;margin:16px 0 8px 0">$1</h3>');
        html = html.replace(/^## (.*$)/gm, '<h2 style="font-size:1.3em;font-weight:600;margin:20px 0 10px 0">$1</h2>');
        html = html.replace(/^# (.*$)/gm, '<h1 style="font-size:1.5em;font-weight:700;margin:24px 0 12px 0">$1</h1>');
        
        // Unordered lists: - item or * item
        html = html.replace(/^[\-\*] (.+)$/gm, '<li style="margin:4px 0;padding-left:8px">$1</li>');
        // Wrap consecutive list items in <ul>
        html = html.replace(/(<li[^>]*>.*?<\/li>(?:\s*<li[^>]*>.*?<\/li>)*)/gs, '<ul style="margin:8px 0;padding-left:24px;list-style-type:disc">$1</ul>');
        
        // Ordered lists: 1. item
        html = html.replace(/^\d+\. (.+)$/gm, '<li style="margin:4px 0;padding-left:8px">$1</li>');
        // Wrap consecutive ordered list items in <ol>
        html = html.replace(/(<li[^>]*>.*?<\/li>(?:\s*<li[^>]*>.*?<\/li>)*)/gs, function(match) {
            if (!match.includes('<ul')) {
                return '<ol style="margin:8px 0;padding-left:24px;list-style-type:decimal">' + match + '</ol>';
            }
            return match;
        });
        
        // Line breaks: convert \n\n to paragraph breaks, \n to <br>
        const paragraphs = html.split(/\n\n+/);
        html = paragraphs.map(p => {
            p = p.trim();
            if (!p) return '';
            // Don't wrap if it's already a block element
            if (p.startsWith('<h') || p.startsWith('<ul') || p.startsWith('<ol') || p.startsWith('<li')) {
                return p.replace(/\n/g, '<br>');
            }
            return '<p style="margin:8px 0;line-height:1.6">' + p.replace(/\n/g, '<br>') + '</p>';
        }).join('');
        
        return html;
    }

    function renderMessageContent(parts) {
        const container = document.createElement('div');
        parts.forEach((part, index) => {
            if (part.type === 'text') {
                const textDiv = document.createElement('div');
                textDiv.className = 'markdown-content';
                textDiv.innerHTML = parseMarkdown(part.content);
                textDiv.style.wordWrap = 'break-word';
                container.appendChild(textDiv);
            } else if (part.type === 'code') {
                container.appendChild(createCodeBlock(part.language, part.content));
            }
        });
        return container;
    }
    
    // Enhanced streaming code block detector for real-time parsing
    function streamingCodeBlockDetector(contentElement, fullContent) {
        // Check if content contains code blocks
        const hasCodeBlock = /```[a-zA-Z0-9_+-]*\n[\s\S]*?```/.test(fullContent);
        
        if (hasCodeBlock) {
            // Re-parse and re-render if code blocks are detected
            const parts = parseMessageContent(fullContent);
            contentElement.innerHTML = '';
            contentElement.appendChild(renderMessageContent(parts));
            
            // Trigger syntax highlighting for new code blocks
            contentElement.querySelectorAll('pre code').forEach(block => {
                if (block.className.startsWith('language-')) {
                    Prism.highlightElement(block);
                }
            });
        }
    }

    // Enhanced auto-scroll function
    function scrollToBottom(smooth = true) {
        if (smooth) {
            messagesList.scrollTo({
                top: messagesList.scrollHeight,
                behavior: 'smooth'
            });
        } else {
            messagesList.scrollTop = messagesList.scrollHeight;
        }
        // Hide scroll button after scrolling
        setTimeout(() => {
            checkScrollPosition();
        }, 300);
    }
    
    // Check if user is at bottom of chat
    function checkScrollPosition() {
        const scrollBtn = document.getElementById('scrollToBottomBtn');
        if (!scrollBtn) return;
        
        const threshold = 100; // Show button if more than 100px from bottom
        const isNearBottom = messagesList.scrollHeight - messagesList.scrollTop - messagesList.clientHeight < threshold;
        
        if (isNearBottom) {
            scrollBtn.classList.remove('show');
        } else {
            scrollBtn.classList.add('show');
        }
    }
    

    function appendMessage(role, content, saveToChat = true) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `${role} message`;

        const contentDiv = document.createElement('div');
        contentDiv.className = 'content';

        const parts = parseMessageContent(content);
        const renderedContent = renderMessageContent(parts);
        contentDiv.appendChild(renderedContent);

        msgDiv.appendChild(contentDiv);
        messagesList.appendChild(msgDiv);
        
        // Auto-scroll to bottom after content is fully rendered
        // Use multiple requestAnimationFrame calls to ensure DOM is fully updated
        requestAnimationFrame(() => {
            requestAnimationFrame(() => {
                scrollToBottom(false); // Use instant scroll for new messages
                // Also set scrollTop directly as fallback
                setTimeout(() => {
                    messagesList.scrollTop = messagesList.scrollHeight;
                    checkScrollPosition();
                }, 100);
            });
        });

        if (saveToChat && state.currentChatId) {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            if (chat) {
                chat.messages.push({ role, content });
                if (chat.title === 'New Chat' && role === 'user') {
                    chat.title = content.substring(0, 50) + (content.length > 50 ? '...' : '');
                    renderChatList();
                }
                saveChats();
            }
        }

        return contentDiv;
    }

    // Send message
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });

    // Web search function
    async function searchWeb(query) {
        if (!state.enableWebSearch) return null;
        
        const provider = localStorage.getItem('search_provider') || 'duckduckgo';
        const apiKey = localStorage.getItem('web_search_key') || '';
        
        try {
            if (provider === 'duckduckgo') {
                // DuckDuckGo Instant Answer API (no key needed)
                const response = await fetch(`https://api.duckduckgo.com/?q=${encodeURIComponent(query)}&format=json&no_html=1&skip_disambig=1`);
                const data = await response.json();
                
                if (data.AbstractText) {
                    return {
                        source: 'DuckDuckGo',
                        summary: data.AbstractText,
                        url: data.AbstractURL,
                        results: []
                    };
                }
                
                // Fallback: Use DuckDuckGo HTML search (scraping via proxy)
                return await searchDuckDuckGoHTML(query);
            } else if (provider === 'google' && apiKey) {
                // Google Custom Search API
                const cx = localStorage.getItem('google_cx') || ''; // Search Engine ID
                const response = await fetch(`https://www.googleapis.com/customsearch/v1?key=${apiKey}&cx=${cx}&q=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.items && data.items.length > 0) {
                    return {
                        source: 'Google',
                        summary: data.items[0].snippet,
                        url: data.items[0].link,
                        results: data.items.slice(0, 5).map(item => ({
                            title: item.title,
                            snippet: item.snippet,
                            link: item.link
                        }))
                    };
                }
            } else if (provider === 'serpapi' && apiKey) {
                // SerpAPI
                const response = await fetch(`https://serpapi.com/search.json?engine=google&q=${encodeURIComponent(query)}&api_key=${apiKey}`);
                const data = await response.json();
                
                if (data.organic_results && data.organic_results.length > 0) {
                    return {
                        source: 'SerpAPI',
                        summary: data.organic_results[0].snippet,
                        url: data.organic_results[0].link,
                        results: data.organic_results.slice(0, 5).map(item => ({
                            title: item.title,
                            snippet: item.snippet,
                            link: item.link
                        }))
                    };
                }
            }
        } catch (err) {
            console.error('Web search error:', err);
            return null;
        }
        
        return null;
    }
    
    // Fallback DuckDuckGo HTML search (using a CORS proxy)
    async function searchDuckDuckGoHTML(query) {
        try {
            // Using a public CORS proxy (you may want to use your own)
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(`https://html.duckduckgo.com/html/?q=${encodeURIComponent(query)}`)}`;
            const response = await fetch(proxyUrl);
            const data = await response.json();
            
            // Parse HTML (simplified - you might want to use a proper parser)
            const parser = new DOMParser();
            const doc = parser.parseFromString(data.contents, 'text/html');
            const results = Array.from(doc.querySelectorAll('.result')).slice(0, 5).map(result => {
                const titleEl = result.querySelector('.result__title');
                const snippetEl = result.querySelector('.result__snippet');
                const linkEl = result.querySelector('.result__a');
                
                return {
                    title: titleEl?.textContent || '',
                    snippet: snippetEl?.textContent || '',
                    link: linkEl?.href || ''
                };
            });
            
            if (results.length > 0) {
                return {
                    source: 'DuckDuckGo',
                    summary: results[0].snippet,
                    url: results[0].link,
                    results: results
                };
            }
        } catch (err) {
            console.error('DuckDuckGo HTML search error:', err);
        }
        
        return null;
    }

    async function sendMessage() {
        const text = messageInput.value.trim();
        if (!text && !codeAttachment) return;

        // Check if disposable chat mode - create new chat each time
        if (state.disposableChat && state.currentChatId) {
            createNewChat();
        } else if (!state.currentChatId) {
            createNewChat();
        }

        // Format message with code attachment if present
        let messageText = text;
        if (codeAttachment) {
            messageText = text ? `${text}\n\n[Code Attachment - ${codeAttachment.language}]:\n\`\`\`${codeAttachment.language}\n${codeAttachment.content}\n\`\`\`` : 
                          `[Code Attachment - ${codeAttachment.language}]:\n\`\`\`${codeAttachment.language}\n${codeAttachment.content}\n\`\`\``;
        }

        appendMessage('user', messageText);
        messageInput.value = '';
        codeAttachment = null;
        hideCodeAttachment();

        const model = document.getElementById('modelSelect').value;
        const temperature = parseFloat(localStorage.getItem('temperature') || '0.7');
        const max_tokens = parseInt(localStorage.getItem('max_tokens') || '1024', 10);

        const placeholder = appendMessage('assistant', '...');

        try {
            const chat = state.chats.find(c => c.id === state.currentChatId);
            let history = chat ? chat.messages : [];
            
            // Perform web search if enabled and query seems to need it
            let searchContext = '';
            if (state.enableWebSearch && (messageText.toLowerCase().includes('search') || messageText.toLowerCase().includes('find') || messageText.toLowerCase().includes('latest') || messageText.toLowerCase().includes('current') || messageText.toLowerCase().includes('recent'))) {
                placeholder.textContent = 'Searching the web...';
                const searchResults = await searchWeb(text || messageText);
                if (searchResults) {
                    searchContext = `\n\n[Web Search Results]\nSource: ${searchResults.source}\nSummary: ${searchResults.summary}\nURL: ${searchResults.url}`;
                    if (searchResults.results && searchResults.results.length > 0) {
                        searchContext += `\n\nAdditional Results:\n${searchResults.results.map((r, i) => `${i + 1}. ${r.title}: ${r.snippet} (${r.link})`).join('\n')}`;
                    }
                }
            }

            // Add search context to the message
            const enhancedText = messageText + searchContext;
            
            // Add user message to history for API call
            const historyWithUser = [...history, { role: 'user', content: enhancedText }];

            let reply = '';
            if (state.provider === 'openai') {
                reply = await callOpenAI(historyWithUser, model, temperature, max_tokens);
            } else if (state.provider === 'anthropic') {
                reply = await callAnthropic(historyWithUser, model, temperature, max_tokens);
            } else if (state.provider === 'deepseek') {
                reply = await callDeepSeek(historyWithUser, model, temperature, max_tokens);
            }

            if (chat) {
                // In disposable mode, clear history after each response
                if (state.disposableChat) {
                    chat.messages = [
                        { role: 'user', content: messageText },
                        { role: 'assistant', content: reply }
                    ];
                } else {
                    chat.messages.push({ role: 'assistant', content: reply });
                }
                saveChats();
            }

            // Dynamically parse and render content with enhanced code detection
            const parts = parseMessageContent(reply);
            placeholder.innerHTML = '';
            const renderedContent = renderMessageContent(parts);
            placeholder.appendChild(renderedContent);
            
            // Apply syntax highlighting to all code blocks
            placeholder.querySelectorAll('pre code').forEach(block => {
                if (block.className.startsWith('language-')) {
                    Prism.highlightElement(block);
                }
            });
            
            // Auto-scroll after rendering - double RAF ensures full layout completion
            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    scrollToBottom(false); // Use instant scroll for new messages
                    // Also set scrollTop directly as fallback
                    setTimeout(() => {
                        messagesList.scrollTop = messagesList.scrollHeight;
                        checkScrollPosition();
                    }, 100);
                });
            });
        } catch (err) {
            placeholder.textContent = 'Error: ' + (err.message || String(err));
        }
    }

    async function callOpenAI(history, model, temperature, max_tokens) {
        const key = localStorage.getItem('openai_key');
        if (!key) throw new Error('OpenAI key not set. Please add it in Settings.');
        const endpoint = 'https://api.openai.com/v1/chat/completions';
        
        const messages = [
            { role: 'system', content: state.jailbreaks.openai }
        ].concat(history.map(m => ({ role: m.role, content: m.content })));
        
        const body = { model: model || 'gpt-4o-mini', messages, temperature, max_tokens };
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
            body: JSON.stringify(body)
        });
        if (!res.ok) {
            const t = await res.text();
            throw new Error(res.status + ' ' + t);
        }
        const data = await res.json();
        if (data.choices && data.choices[0] && data.choices[0].message) return data.choices[0].message.content;
        return JSON.stringify(data);
    }

    async function callAnthropic(history, model, temperature, max_tokens) {
        const key = localStorage.getItem('anthropic_key');
        if (!key) throw new Error('Anthropic key not set. Please add it in Settings.');
        const endpoint = 'https://api.anthropic.com/v1/messages';
        
        const messages = history.map(m => ({ role: m.role, content: m.content }));
        
        const body = { 
            model: model || 'claude-3-5-sonnet-20241022', 
            system: state.jailbreaks.anthropic,
            messages, 
            max_tokens, 
            temperature 
        };
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': key,
                'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify(body)
        });
        if (!res.ok) {
            const t = await res.text();
            throw new Error(res.status + ' ' + t);
        }
        const data = await res.json();
        if (data.content && data.content[0] && data.content[0].text) return data.content[0].text;
        return JSON.stringify(data);
    }

    async function callDeepSeek(history, model, temperature, max_tokens) {
        const key = localStorage.getItem('deepseek_key');
        if (!key) throw new Error('DeepSeek key not set. Please add it in Settings.');
        const endpoint = 'https://api.deepseek.com/chat/completions';
        
        const messages = [
            { role: 'system', content: state.jailbreaks.deepseek }
        ].concat(history.map(m => ({ role: m.role, content: m.content })));
        
        const body = { model: model || 'deepseek-chat', messages, temperature, max_tokens };
        const res = await fetch(endpoint, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + key },
            body: JSON.stringify(body)
        });
        if (!res.ok) {
            const t = await res.text();
            throw new Error(res.status + ' ' + t);
        }
        const data = await res.json();
        if (data.choices && data.choices[0] && data.choices[0].message) return data.choices[0].message.content;
        return JSON.stringify(data);
    }

    // Auto-resize textarea
    messageInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 200) + 'px';
    });
    
    // Code paste detection - treat as attachment
    let codeAttachment = null;
    messageInput.addEventListener('paste', function(e) {
        const pastedText = (e.clipboardData || window.clipboardData).getData('text');
        
        // Detect if pasted content looks like code
        const codeIndicators = [
            /^\s*(function|const|let|var|class|import|export|def |\w+\s*=\s*\{|\w+\s*=\s*\[)/m, // Common code patterns
            /^\s*```/m, // Markdown code blocks
            /^\s*<\?php|<\?xml|<!DOCTYPE|<html|import\s+\w+|from\s+\w+|package\s+\w+/m, // File headers
            /[{};]|=>|->|::|\+\+|--/ // Code syntax
        ];
        
        const looksLikeCode = codeIndicators.some(pattern => pattern.test(pastedText)) || 
                             (pastedText.split('\n').length > 5 && pastedText.length > 100);
        
        if (looksLikeCode && pastedText.trim().length > 20) {
            e.preventDefault();
            
            // Store as attachment
            codeAttachment = {
                type: 'code',
                content: pastedText.trim(),
                language: detectLanguage(pastedText)
            };
            
            // Show attachment indicator
            showCodeAttachment(codeAttachment);
        } else {
            codeAttachment = null;
            hideCodeAttachment();
        }
    });
    
    // Detect programming language from code
    function detectLanguage(code) {
        const patterns = {
            javascript: /(function|const|let|var|=>|\.js)/,
            python: /(def |import |from |\.py|print\(|if __name__)/,
            java: /(public class|import java|\.java)/,
            html: /(<!DOCTYPE|<html|<head|<body)/,
            css: /(@media|@import|\.css|#[a-fA-F0-9]{3,6})/,
            json: /(\{[\s\S]*\}|\[[\s\S]*\])/,
            sql: /(SELECT|INSERT|UPDATE|DELETE|CREATE TABLE)/,
            bash: /(\#\!\/bin|\#\!\/usr\/bin|echo |grep |awk |sed )/,
            cpp: /(#include|using namespace|std::|\.cpp|\.hpp)/,
            c: /(#include|int main|\.c|\.h)/,
            go: /(package |import \(|func |\.go)/,
            rust: /(fn |use |let mut|\.rs)/,
            php: /(<\?php|\$_|->|::)/
        };
        
        for (const lang in patterns) {
            if (patterns[lang].test(code)) {
                return lang;
            }
        }
        
        return 'text';
    }
    
    // Show code attachment indicator
    function showCodeAttachment(attachment) {
        let indicator = document.getElementById('codeAttachmentIndicator');
        if (!indicator) {
            indicator = document.createElement('div');
            indicator.id = 'codeAttachmentIndicator';
            indicator.className = 'code-attachment-indicator';
            indicator.innerHTML = `
                <div style="display:flex;align-items:center;gap:8px;padding:8px 12px;background:rgba(99,102,241,0.15);border:1px solid rgba(99,102,241,0.3);border-radius:8px;margin-bottom:8px;">
                    <i class="fa fa-code" style="color:var(--color-gpt3)"></i>
                    <span style="color:var(--color-white);font-size:0.85em;flex:1">Code attachment (${attachment.language})</span>
                    <button onclick="removeCodeAttachment()" style="background:none;border:none;color:var(--color-groupings);cursor:pointer;padding:4px 8px;border-radius:4px;transition:all 0.2s">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
            `;
            const messageForm = document.getElementById('message-form');
            messageForm.insertBefore(indicator, messageForm.firstChild);
        } else {
            indicator.querySelector('span').textContent = `Code attachment (${attachment.language})`;
            indicator.style.display = 'block';
        }
    }
    
    // Hide code attachment indicator
    function hideCodeAttachment() {
        const indicator = document.getElementById('codeAttachmentIndicator');
        if (indicator) {
            indicator.style.display = 'none';
        }
    }
    
    // Remove code attachment
    window.removeCodeAttachment = function() {
        codeAttachment = null;
        hideCodeAttachment();
    };

    // Initialize scroll button functionality
    const scrollBtn = document.getElementById('scrollToBottomBtn');
    if (scrollBtn) {
        scrollBtn.addEventListener('click', () => {
            scrollToBottom(true);
        });
    }
    
    // Check scroll position on scroll
    if (messagesList) {
        messagesList.addEventListener('scroll', checkScrollPosition);
        // Also check on resize
        window.addEventListener('resize', checkScrollPosition);
    }

    // Startup menu handlers
    const getStartedBtn = document.getElementById('getStartedBtn');
    const githubBtn = document.getElementById('githubBtn');
    
    if (getStartedBtn) {
        getStartedBtn.addEventListener('click', () => {
            if (startupModal) {
                startupModal.classList.remove('show');
                localStorage.setItem('startup_seen', 'true');
            }
        });
    }
    
    if (githubBtn) {
        githubBtn.addEventListener('click', () => {
            window.open('https://github.com/levifrsn63/Jailbreak.lm', '_blank');
        });
    }

    // Initialize
    (function() {
        // Check if startup menu should be shown
        const startupSeen = localStorage.getItem('startup_seen');
        if (!startupSeen && startupModal) {
            startupModal.classList.add('show');
        }
        
        // Set sidebar to hidden state on load
        if (state.sidebarHidden) {
            sidebar.classList.add('hidden');
            document.body.classList.add('sidebar-hidden');
        }
        
        // Apply theme on load
        const savedTheme = localStorage.getItem('theme') || 'dark';
        window.applyTheme(savedTheme);
        
        if (state.chats.length === 0) {
            newChatView.style.display = 'flex';
            conversationView.style.display = 'none';
        } else {
            renderChatList();
            loadChat(state.chats[0].id);
        }

        // Set selected provider button
        document.querySelectorAll('.model-selector button').forEach(btn => {
            if (btn.dataset.provider === state.provider) {
                btn.classList.add('selected');
            }
        });
        
        // Initial scroll position check
        setTimeout(() => {
            checkScrollPosition();
        }, 500);
    })();
    </script>
</body>
</html>
